<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F5 Device Capacity Monitor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
/* Keep all your previous CSS here unchanged */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px; min-height:100vh; }
.header { text-align:center; margin-bottom:30px; animation:fadeIn 0.5s ease-in; }
.header h1 { font-size:2.5rem; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
.header .subtitle { font-size:1.1rem; opacity:0.9; }
.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:15px; }
.refresh-btn { background: rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); color:white; padding:12px 24px; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600; transition: all 0.3s ease; backdrop-filter:blur(10px); }
.refresh-btn:hover { background: rgba(255,255,255,0.3); transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.2); }
.last-update { background: rgba(0,0,0,0.2); padding:10px 20px; border-radius:8px; font-size:0.95rem; }
.dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(380px,1fr)); gap:20px; margin-bottom:30px; }
.device-card { background: rgba(255,255,255,0.1); backdrop-filter:blur(10px); border-radius:15px; padding:25px; border:1px solid rgba(255,255,255,0.2); transition:all 0.3s ease; animation:slideUp 0.5s ease-out; }
.device-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,0.3); border-color:rgba(255,255,255,0.4); }
.device-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid rgba(255,255,255,0.2); }
.device-name { font-size:1.5rem; font-weight:bold; }
.status-badge { padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; text-transform:uppercase; }
.status-online { background:#10b981; color:white; }
.status-offline { background:#ef4444; color:white; }
.location { font-size:0.9rem; opacity:0.8; margin-bottom:20px; }
.metrics-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-bottom:20px; }
.metric-box { background: rgba(0,0,0,0.2); padding:15px; border-radius:10px; transition: all 0.3s ease; }
.metric-box:hover { background: rgba(0,0,0,0.3); transform: scale(1.05); }
.metric-label { font-size:0.85rem; opacity:0.8; margin-bottom:8px; }
.metric-value { font-size:1.8rem; font-weight:bold; display:flex; align-items:baseline; gap:5px; }
.metric-unit { font-size:0.9rem; opacity:0.7; }
.progress-bar { width:100%; height:8px; background:rgba(0,0,0,0.3); border-radius:10px; overflow:hidden; margin-top:8px; }
.progress-fill { height:100%; background:linear-gradient(90deg,#10b981,#3b82f6); border-radius:10px; transition:width 0.5s ease; }
.progress-fill.warning { background:linear-gradient(90deg,#f59e0b,#ef4444); }
.hardware-health { background: rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-top:15px; }
.health-title { font-size:1rem; font-weight:600; margin-bottom:10px; }
.health-items { display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; }
.health-item { display:flex; align-items:center; gap:8px; font-size:0.9rem; }
.health-icon { width:8px; height:8px; border-radius:50%; background:#10b981; }
.health-icon.warning { background:#f59e0b; }
.chart-section { background: rgba(255,255,255,0.1); backdrop-filter:blur(10px); border-radius:15px; padding:25px; border:1px solid rgba(255,255,255,0.2); margin-top:30px; }
.chart-title { font-size:1.5rem; font-weight:bold; margin-bottom:20px; text-align:center; }
.loading { text-align:center; padding:40px; font-size:1.2rem; }
.spinner { border:4px solid rgba(255,255,255,0.3); border-top:4px solid white; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; }
@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
@keyframes fadeIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
@keyframes slideUp { from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
@media(max-width:768px){ .metrics-grid{ grid-template-columns:1fr; } .dashboard-grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="header">
    <h1>üî• F5 Device Capacity Monitor</h1>
    <div class="subtitle">Real-time monitoring of all F5 load balancers</div>
</div>

<div class="controls">
    <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh Now</button>
    <div class="last-update" id="lastUpdate">Last updated: Loading...</div>
</div>

<div id="dashboard" class="dashboard-grid">
    <div class="loading"><div class="spinner"></div><div>Loading device data...</div></div>
</div>

<div class="chart-section">
    <div class="chart-title">Overall Capacity Utilization</div>
    <canvas id="capacityChart"></canvas>
</div>

<script>
const API_BASE = 'http://localhost:5000/api';
let chart;
let devices = [];

async function fetchDevices() {
    const res = await fetch(`${API_BASE}/devices`);
    devices = await res.json();
    const dashboard = document.getElementById('dashboard');
    dashboard.innerHTML = devices.map(d=>`<div class="device-card" id="card-${d.name}"><div class="loading"><div class="spinner"></div><div>Loading ${d.name}...</div></div></div>`).join('');
    updateAllDevices();
}

async function updateDevice(device) {
    try {
        const res = await fetch(`${API_BASE}/stats/${device.name}`);
        const data = await res.json();
        const card = document.getElementById(`card-${device.name}`);
        if(data.error){ card.innerHTML=`<div class="status-badge status-offline">Offline</div>`; return; }
        card.innerHTML = renderDeviceCard(data);
        updateChartIncremental(data);
        document.getElementById('lastUpdate').textContent = `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
    } catch(e){ console.error(`Error fetching ${device.name}:`, e); }
}

function updateAllDevices(){ devices.forEach(d=>updateDevice(d)); }

function renderDeviceCard(device){
    const statusClass = device.status==='online'?'status-online':'status-offline';
    const cpuWarning = device.cpu_usage>70?'warning':'';
    const memWarning = device.memory_usage>80?'warning':'';
    return `
        <div class="device-header">
            <div class="device-name">${device.device_name}</div>
            <div class="status-badge ${statusClass}">${device.status}</div>
        </div>
        <div class="location">üìç ${device.location}</div>
        <div class="metrics-grid">
            <div class="metric-box"><div class="metric-label">Concurrent Connections</div><div class="metric-value">${device.concurrent_connections.toLocaleString()}</div></div>
            <div class="metric-box"><div class="metric-label">CPU Usage</div><div class="metric-value">${device.cpu_usage}<span class="metric-unit">%</span></div><div class="progress-bar"><div class="progress-fill ${cpuWarning}" style="width:${device.cpu_usage}%"></div></div></div>
            <div class="metric-box"><div class="metric-label">Memory Usage</div><div class="metric-value">${device.memory_usage}<span class="metric-unit">%</span></div><div class="progress-bar"><div class="progress-fill ${memWarning}" style="width:${device.memory_usage}%"></div></div></div>
            <div class="metric-box"><div class="metric-label">Throughput (In/Out)</div><div class="metric-value">${device.throughput_in.toFixed(1)} / ${device.throughput_out.toFixed(1)}<span class="metric-unit">Mbps</span></div></div>
        </div>
        <div class="metric-box"><div class="metric-label">Latency</div><div class="metric-value">${device.latency}<span class="metric-unit">ms</span></div></div>
        <div class="hardware-health">
            <div class="health-title">‚öôÔ∏è Hardware Health</div>
            <div class="health-items">
                <div class="health-item"><div class="health-icon"></div><span>Temp: ${device.hardware_health.temperature}¬∞C</span></div>
                <div class="health-item"><div class="health-icon ${device.hardware_health.fan_status!=='OK'?'warning':''}"></div><span>Fan: ${device.hardware_health.fan_status}</span></div>
                <div class="health-item"><div class="health-icon"></div><span>PSU: ${device.hardware_health.power_supply}</span></div>
            </div>
        </div>
    `;
}

function updateChartIncremental(device){
    if(!chart){
        const ctx = document.getElementById('capacityChart').getContext('2d');
        chart = new Chart(ctx,{type:'bar',data:{labels:devices.map(d=>d.name),datasets:[
            {label:'CPU Usage (%)', data:devices.map(d=>0), backgroundColor:'rgba(59,130,246,0.7)', borderColor:'rgba(59,130,246,1)', borderWidth:2},
            {label:'Memory Usage (%)', data:devices.map(d=>0), backgroundColor:'rgba(16,185,129,0.7)', borderColor:'rgba(16,185,129,1)', borderWidth:2}
        ]},options:{responsive:true, maintainAspectRatio:true, scales:{y:{beginAtZero:true,max:100,ticks:{color:'white'},grid:{color:'rgba(255,255,255,0.1)'}}, x:{ticks:{color:'white'},grid:{color:'rgba(255,255,255,0.1)'}}}, plugins:{legend:{labels:{color:'white',font:{size:14}}}}}});
    }
    const index = devices.findIndex(d=>d.name===device.device_name);
    if(index>=0){ chart.data.datasets[0].data[index]=device.cpu_usage; chart.data.datasets[1].data[index]=device.memory_usage; chart.update(); }
}

function refreshAll(){ updateAllDevices(); }

fetchDevices();
setInterval(updateAllDevices,30000);
</script>
</body>
</html>
